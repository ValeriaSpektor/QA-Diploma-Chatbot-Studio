name: CI/CD Pipeline with Docker and Telegram Notifications

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  docker-tests:
    runs-on: ubuntu-latest

    steps:
      # Шаг 1: Клонирование кода
      - name: Checkout Code
        uses: actions/checkout@v3

      # Шаг 2: Сборка Docker-образа для автотестов
      - name: Build Docker Image
        run: docker build -t autotests .

      # Шаг 3: Запуск тестов и загрузка результатов в Allure TestOps
      - name: Run Tests and Upload to Allure TestOps
        run: |
          docker run --rm \
            -e ALLURE_PROJECT_ID=${{ secrets.ALLURE_PROJECT_ID }} \
            -e ALLURE_SERVER_URL=${{ secrets.ALLURE_SERVER_URL }} \
            -e ALLURE_TOKEN=${{ secrets.ALLURE_TOKEN }} \
            autotests

      # Шаг 4: Уведомление в Telegram
      - name: Send Notification to Telegram
        if: always()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
              "text": "\uD83D\uDCE2 CI/CD Pipeline Completed\n\nJob: docker-tests\nStatus: ${{ job.status }}\n\nCheck Allure TestOps for detailed results."
            }'
