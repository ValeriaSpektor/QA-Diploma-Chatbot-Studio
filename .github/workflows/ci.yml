name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  ALLURE_PROJECT_ID: "your-allure-project-id"
  ALLURE_SERVER_URL: "https://allure.your-server.com"
  ALLURE_TOKEN: "${{ secrets.ALLURE_TOKEN }}"
  TELEGRAM_BOT_TOKEN: "${{ secrets.TELEGRAM_BOT_TOKEN }}"
  TELEGRAM_CHAT_ID: "${{ secrets.TELEGRAM_CHAT_ID }}"
  ALLURE_REPORT_URL: "https://allure.your-server.com/project/your-project-id"

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # Проверка кода из репозитория
    - name: Checkout code
      uses: actions/checkout@v3

    # Установка Docker Buildx
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Логин в DockerHub (если требуется)
    - name: Log in to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # Сборка Docker-образа
    - name: Build Docker Image
      run: |
        docker build . -t playwright-tests

    # Запуск тестов в Docker
    - name: Run Tests Inside Docker
      run: |
        docker run --rm \
          -e ALLURE_PROJECT_ID=$ALLURE_PROJECT_ID \
          -e ALLURE_SERVER_URL=$ALLURE_SERVER_URL \
          -e ALLURE_TOKEN=$ALLURE_TOKEN \
          -e TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN \
          -e TELEGRAM_CHAT_ID=$TELEGRAM_CHAT_ID \
          -e ALLURE_REPORT_URL=$ALLURE_REPORT_URL \
          playwright-tests

    # Генерация Allure отчета (если не генерируется автоматически в entrypoint.sh)
    - name: Generate Allure Report
      run: |
        allure generate allure-results --clean -o allure-report

    # Отправка Telegram уведомления (если не отправляется из Docker)
    - name: Send Telegram Notification
      run: |
        curl -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
             -d chat_id=$TELEGRAM_CHAT_ID \
             -d text="CI/CD завершен. Отчет доступен по ссылке: $ALLURE_REPORT_URL"

    # Публикация Allure отчета (если требуется вручную загрузить отчет)
    - name: Upload Allure Report
      run: |
        ./allurectl upload --project-id $ALLURE_PROJECT_ID \
                           --results-dir allure-results \
                           --server $ALLURE_SERVER_URL \
                           --token $ALLURE_TOKEN
