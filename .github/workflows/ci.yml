name: CI-CD Pipeline with Docker

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v3

      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # –°–æ–±–∏—Ä–∞–µ–º Docker-–æ–±—Ä–∞–∑
      - name: Build Docker Image
        run: docker build -t my-docker-image .

      # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ Docker
      - name: Run Tests in Docker Container
        run: |
          docker run --rm \
          -v ${{ github.workspace }}/allure-results:/app/allure-results \
          -v ${{ github.workspace }}/allure-report:/app/allure-report \
          my-docker-image

      # –î–µ–ø–ª–æ–π –æ—Ç—á–µ—Ç–∞ Allure –Ω–∞ GitHub Pages
      - name: Deploy Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report

      # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
      - name: Notify Telegram
        run: |
          curl -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
               -F document=@allure-report/index.html \
               -F caption="üìù Allure Report\n
‚úÖ Passed: 87\n
‚ùå Failed: 10\n
‚ö†Ô∏è Broken: 2\n
‚ûñ Skipped: 1\n
üìä Total: 100\n\n
üîó View the report: https://<–≤–∞—à-—Å–∞–π—Ç>/allure-report/" \
               https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument
