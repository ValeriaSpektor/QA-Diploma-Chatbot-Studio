name: build-and-test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # Шаг 1: Проверка репозитория
    - name: Checkout repository
      uses: actions/checkout@v3

    # Шаг 2: Установка Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    # Шаг 3: Установка зависимостей
    - name: Install dependencies
      run: npm ci

    # Шаг 4: Запуск тестов
    - name: Run tests
      run: npm test

    # Шаг 5: Генерация отчёта Allure
    - name: Generate Allure Report
      run: |
        npm install allure-commandline --save-dev
        npx allure generate allure-results --clean
        npx allure open allure-report

    # Шаг 6: Деплой отчёта на GitHub Pages
    - name: Deploy Allure Report to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GH_PAT }}
        publish_dir: ./allure-report

    # Шаг 7: Отправка файла отчёта в Telegram
    - name: Send Allure Report to Telegram
      if: ${{ always() }}
      run: |
        curl -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
             -F "document=@allure-report/history/history-trend.json" \
             "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument"

    # Шаг 8: Уведомление о статусе сборки (опционально)
    - name: Send build status to Telegram
      if: ${{ always() }}
      run: |
        curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "'${{ secrets.TELEGRAM_CHAT_ID }}'",
            "text": "Build Status: '${{ job.status }}'. View Report: https://valeriaspektor.github.io/QA-Diploma-Chatbot-Studio/"
          }'
